import sys
from pathlib import Path
from typing import Dict

# should be installed by run_once_after_122_ubuntu.sh
import tomlkit


def merge_dicts(source: Dict, target: Dict) -> Dict:
    """
    Merge source dict into target dict. Source dict has higher priority.

    :param source: Source dict.
    :param target: Target dict.
    :return: Merged dict.
    """
    for key, value in source.items():
        if isinstance(value, dict) and key in target and isinstance(target[key], dict):
            target[key] = merge_dicts(value, target[key])
        else:
            target[key] = value
    return target

def overwrite_settings(
    target_path: Path, target_dict: Dict, verbose: bool = False
) -> bool:
    """
    Overwrite target settings file with target_dict.

    :param target_path: Path to target settings file.
    :param target_dict: Settings dict to write.
    :param verbose: Whether to print merged settings and ask for confirmation.
    :return: True if written, False if aborted.
    """
    target_json_str = tomlkit.dumps(target_dict)

    print("=" * 40)
    print("Merged settings:")
    print(target_json_str)
    print("=" * 40)

    do_write = True
    if verbose:
        answer = input(f"Write merged settings to {target_path}? (y/n): ")
        do_write = answer.lower() == "y"

    if do_write:
        target_path.parent.mkdir(parents=True, exist_ok=True)
        with target_path.open("w", encoding="utf-8") as f:
            f.write(target_json_str)
        print(f"Wrote merged settings to {target_path}.")
    else:
        print("Aborted.")

    return do_write


def main():
    root_path = Path("{{ .chezmoi.sourceDir }}").parent
    source_path = root_path / "config" / "unix" / "codex.toml"

    # Load source config
    if not source_path.exists():
        print(f"Error: Source file not found: {source_path}", file=sys.stderr)
        sys.exit(1)

    try:
        with source_path.open("rb") as f:
            source_dict = tomlkit.load(f)
    except Exception as e:
        print(f"Error reading source file {source_path}: {e}", file=sys.stderr)
        sys.exit(1)

    # Load existing target config if it exists
    target_path = Path("~/.codex/config.toml").expanduser()
    target_dict = {}

    if target_path.exists():
        try:
            with target_path.open("rb") as f:
                target_dict = tomlkit.load(f)
        except Exception as e:
            print(f"Warning: Failed to read existing config {target_path}: {e}")
            print("Proceeding with empty target config...")

    # Merge and write
    target_dict = merge_dicts(source_dict, target_dict)
    try:
        overwrite_settings(target_path, target_dict, verbose=False)
    except Exception as e:
        print(f"Error writing config to {target_path}: {e}", file=sys.stderr)
        sys.exit(1)

main()
